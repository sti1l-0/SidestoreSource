name: Update AltStore Source

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update-source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Update Apps JSON
        run: |
          # 格式：仓库名|应用名|后缀
          APPS=("open-ani/animeko|Animeko|.ipa" "bggRGjQaUbCoE/PiliPlus|PiliPlus|.ipa")

          for APP in "${APPS[@]}"; do
            IFS="|" read -r REPO NAME EXT <<< "$APP"
            echo "--------------------------------------------"
            echo "Checking updates for $NAME ($REPO)..."

            API_URL="https://api.github.com/repos/$REPO/releases/latest"
            # 获取最新正式版 Release 信息
            RELEASE_DATA=$(curl -sL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$API_URL")

            if [[ -z "$RELEASE_DATA" || "$RELEASE_DATA" == *"message"* ]]; then
              echo "Error: Could not fetch data for $REPO. Skipping."
              continue
            fi

            VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name | sed 's/v//')
            DATE=$(echo "$RELEASE_DATA" | jq -r .published_at | cut -d'T' -f1)
            
            # 使用 endswith 检查匹配后缀的第一个资产
            ASSET=$(echo "$RELEASE_DATA" | jq -c --arg ext "$EXT" '.assets[] | select(.name | endswith($ext))' | head -n 1)
            
            if [ -z "$ASSET" ]; then
              echo "Warning: No assets ending with $EXT found for $NAME. Skipping..."
              continue
            fi

            RAW_URL=$(echo "$ASSET" | jq -r .browser_download_url)
            SIZE=$(echo "$ASSET" | jq -r .size)
            
            # --- 修改此处为 gh-proxy.org ---
            DL_URL="https://gh-proxy.org/$RAW_URL"

            # 更新 JSON 文件
            if jq --arg name "$NAME" --arg ver "$VERSION" --arg dl "$DL_URL" --arg size "$SIZE" --arg date "$DATE" \
              '(.apps[] | select(.name == $name) | .versions[0]) |= (.version = $ver | .downloadURL = $dl | .size = ($size|tonumber) | .date = $date)' \
              apps.json > apps.json.tmp; then
                mv apps.json.tmp apps.json
                echo "Successfully updated $NAME to version $VERSION"
            else
                echo "Error: Failed to process JSON for $NAME."
                rm -f apps.json.tmp
            fi
          done

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: sync latest app releases with gh-proxy"
          file_pattern: 'apps.json'
