name: Update AltStore Source

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update-source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Update Apps JSON
        run: |
          # 格式：仓库名|应用名|后缀|分类
          APPS=("open-ani/animeko|Animeko|.ipa|entertainment" "bggRGjQaUbCoE/PiliPlus|PiliPlus|.ipa|utilities")

          for APP in "${APPS[@]}"; do
            IFS="|" read -r REPO NAME EXT CAT <<< "$APP"
            echo "--------------------------------------------"
            echo "Processing $NAME ($REPO)..."

            API_URL="https://api.github.com/repos/$REPO/releases/latest"
            RELEASE_DATA=$(curl -sL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$API_URL")

            if [[ -z "$RELEASE_DATA" || "$RELEASE_DATA" == *"message"* ]]; then
              echo "Error: Could not fetch data for $REPO. Skipping."
              continue
            fi

            # 1. 提取基本信息
            VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name | sed 's/v//')
            DATE=$(echo "$RELEASE_DATA" | jq -r .published_at | cut -d'T' -f1)
            
            # 2. 提取资产
            ASSET=$(echo "$RELEASE_DATA" | jq -c --arg ext "$EXT" '.assets[] | select(.name | endswith($ext))' | head -n 1)
            if [ -z "$ASSET" ]; then
              echo "Warning: No $EXT asset found for $NAME. Skipping."
              continue
            fi

            RAW_URL=$(echo "$ASSET" | jq -r .browser_download_url)
            SIZE=$(echo "$ASSET" | jq -r .size)
            DL_URL="https://gh-proxy.org/$RAW_URL"

            # 3. 自动提取图标
            RAW_ICON_URL=$(echo "$RELEASE_DATA" | jq -r .author.avatar_url)
            ICON_URL="https://gh-proxy.org/$RAW_ICON_URL"

            # 4. 原子化更新 JSON (补全所有 SideStore 要求的字段)
            # 使用 select(.name == $name) 定位应用
            # 补全 localizedDescription, category, screenshots, appPermissions, patreon, pledge
            if jq --arg name "$NAME" --arg ver "$VERSION" --arg dl "$DL_URL" --arg size "$SIZE" --arg date "$DATE" --arg icon "$ICON_URL" --arg cat "$CAT" \
              '(.apps[] | select(.name == $name)) |= (
                .iconURL = $icon |
                .category = $cat |
                .localizedDescription = (.localizedDescription // .description // "No description provided.") |
                .screenshots = (.screenshots // []) |
                .appPermissions = (.appPermissions // {}) |
                .patreon = { "pledge": 0 } |
                .versions[0] = {
                  "version": $ver,
                  "date": $date,
                  "downloadURL": $dl,
                  "size": ($size | tonumber),
                  "localizedDescription": ("Updated to version " + $ver)
                }
              )' \
              apps.json > apps.json.tmp; then
                mv apps.json.tmp apps.json
                echo "Successfully updated $NAME to version $VERSION"
            else
                echo "Error: Failed to process JSON for $NAME."
                rm -f apps.json.tmp
            fi
          done

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: sync releases, icons, and fix pledge/description fields"
          file_pattern: 'apps.json'
