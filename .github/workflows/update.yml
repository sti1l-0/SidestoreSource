name: Update AltStore Source

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update-source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Update Apps JSON
        run: |
          # 格式：仓库名|应用名|后缀
          APPS=("open-ani/animeko|Animeko|.ipa" "bggRGjQaUbCoE/PiliPlus|PiliPlus|.ipa")

          for APP in "${APPS[@]}"; do
            IFS="|" read -r REPO NAME EXT <<< "$APP"
            echo "--------------------------------------------"
            echo "Processing $NAME ($REPO)..."

            # 获取最新正式版 Release 信息
            API_URL="https://api.github.com/repos/$REPO/releases/latest"
            RELEASE_DATA=$(curl -sL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$API_URL")

            if [[ -z "$RELEASE_DATA" || "$RELEASE_DATA" == *"message"* ]]; then
              echo "Error: Could not fetch data for $REPO. Skipping."
              continue
            fi

            # 1. 提取版本和日期
            VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name | sed 's/v//')
            DATE=$(echo "$RELEASE_DATA" | jq -r .published_at | cut -d'T' -f1)
            
            # 2. 提取资产 (IPA 文件)
            ASSET=$(echo "$RELEASE_DATA" | jq -c --arg ext "$EXT" '.assets[] | select(.name | endswith($ext))' | head -n 1)
            if [ -z "$ASSET" ]; then
              echo "Warning: No $EXT asset found for $NAME. Skipping."
              continue
            fi

            RAW_URL=$(echo "$ASSET" | jq -r .browser_download_url)
            SIZE=$(echo "$ASSET" | jq -r .size)
            DL_URL="https://gh-proxy.org/$RAW_URL"

            # 3. 自动提取图标 (项目所有者头像)
            RAW_ICON_URL=$(echo "$RELEASE_DATA" | jq -r .author.avatar_url)
            ICON_URL="https://gh-proxy.org/$RAW_ICON_URL"

            # 4. 更新 JSON
            # 逻辑：匹配 name，同时更新 iconURL 和 versions 数组
            if jq --arg name "$NAME" --arg ver "$VERSION" --arg dl "$DL_URL" --arg size "$SIZE" --arg date "$DATE" --arg icon "$ICON_URL" \
              '(.apps[] | select(.name == $name)) |= (.iconURL = $icon | .versions[0].version = $ver | .versions[0].downloadURL = $dl | .versions[0].size = ($size|tonumber) | .versions[0].date = $date)' \
              apps.json > apps.json.tmp; then
                mv apps.json.tmp apps.json
                echo "Successfully updated $NAME to version $VERSION with icon"
            else
                echo "Error: Failed to process JSON for $NAME."
                rm -f apps.json.tmp
            fi
          done

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: releases, icons, and bundle IDs"
          file_pattern: 'apps.json'
