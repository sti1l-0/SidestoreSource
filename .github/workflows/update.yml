name: Update AltStore Source

on:
  schedule:
    - cron: '0 */6 * * *' # 每6小时运行一次
  workflow_dispatch:      # 支持手动触发

jobs:
  update-source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Update Apps JSON
        run: |
          # 定义应用列表：仓库名|应用名|后缀
          # 仓库名已修正为 open-ani/animeko
          APPS=("open-ani/animeko|Animeko|.ios" "bggRGjQaUbCoE/PiliPlus|PiliPlus|.ipa")

          for APP in "${APPS[@]}"; do
            IFS="|" read -r REPO NAME EXT <<< "$APP"
            echo "--------------------------------------------"
            echo "Checking updates for $NAME ($REPO)..."

            # 1. 获取最新正式版 Release 信息
            API_URL="https://api.github.com/repos/$REPO/releases/latest"
            RELEASE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" $API_URL)

            # 检查 API 是否返回了有效数据 (防止 404 或 Rate Limit)
            if echo "$RELEASE_DATA" | jq -e '.message' > /dev/null; then
              echo "Error: API returned message: $(echo "$RELEASE_DATA" | jq -r .message). Skipping $NAME."
              continue
            fi

            # 2. 提取版本和日期
            VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name | sed 's/v//')
            DATE=$(echo "$RELEASE_DATA" | jq -r .published_at | cut -d'T' -f1)
            
            # 3. 提取符合后缀的资产 (Asset)
            # 使用 select 并通过 test 进行正则匹配或 endswith 匹配
            ASSET=$(echo "$RELEASE_DATA" | jq -c ".assets[] | select(.name | endswith(\"$EXT\"))" | head -n 1)
            
            if [ -z "$ASSET" ]; then
              echo "Warning: No assets with extension $EXT found for $NAME. Skipping..."
              continue
            fi

            RAW_URL=$(echo "$ASSET" | jq -r .browser_download_url)
            SIZE=$(echo "$ASSET" | jq -r .size)
            DL_URL="https://mirror.ghproxy.com/?q=$RAW_URL"

            # 4. 原子化更新 JSON
            # 先将更新后的内容存入临时文件，确保只有在成功生成新 JSON 的情况下才替换原文件
            if jq --arg name "$NAME" --arg ver "$VERSION" --arg dl "$DL_URL" --arg size "$SIZE" --arg date "$DATE" \
              '(.apps[] | select(.name == $name) | .versions[0]) |= (.version = $ver | .downloadURL = $dl | .size = ($size|tonumber) | .date = $date)' \
              apps.json > apps.json.tmp; then
                mv apps.json.tmp apps.json
                echo "Successfully updated $NAME to version $VERSION"
            else
                echo "Error: Failed to process JSON for $NAME. Keeping original file."
                rm -f apps.json.tmp
            fi
          done

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: sync latest app releases"
          file_pattern: 'apps.json'
