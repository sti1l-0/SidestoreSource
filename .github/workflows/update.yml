name: Update AltStore Source

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update-source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Update Apps JSON
        run: |
          # 格式：仓库名|应用名|匹配关键字(正则)
          # 将 .ios 改为 .ipa，并支持大小写不敏感匹配
          APPS=("open-ani/animeko|Animeko|\.ipa$" "bggRGjQaUbCoE/PiliPlus|PiliPlus|\.ipa$")

          for APP in "${APPS[@]}"; do
            IFS="|" read -r REPO NAME EXT_PATTERN <<< "$APP"
            echo "--------------------------------------------"
            echo "Checking updates for $NAME ($REPO)..."

            API_URL="https://api.github.com/repos/$REPO/releases/latest"
            RELEASE_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" $API_URL)

            if echo "$RELEASE_DATA" | jq -e '.message' > /dev/null; then
              echo "Error: API returned message: $(echo "$RELEASE_DATA" | jq -r .message). Skipping $NAME."
              continue
            fi

            VERSION=$(echo "$RELEASE_DATA" | jq -r .tag_name | sed 's/v//')
            DATE=$(echo "$RELEASE_DATA" | jq -r .published_at | cut -d'T' -f1)
            
            # 使用 test() 进行正则匹配，忽略大小写
            ASSET=$(echo "$RELEASE_DATA" | jq -c ".assets[] | select(.name | test(\"$EXT_PATTERN\"; \"i\"))" | head -n 1)
            
            if [ -z "$ASSET" ]; then
              echo "Warning: No assets matching pattern $EXT_PATTERN found for $NAME. Skipping..."
              continue
            fi

            RAW_URL=$(echo "$ASSET" | jq -r .browser_download_url)
            SIZE=$(echo "$ASSET" | jq -r .size)
            DL_URL="https://mirror.ghproxy.com/?q=$RAW_URL"

            if jq --arg name "$NAME" --arg ver "$VERSION" --arg dl "$DL_URL" --arg size "$SIZE" --arg date "$DATE" \
              '(.apps[] | select(.name == $name) | .versions[0]) |= (.version = $ver | .downloadURL = $dl | .size = ($size|tonumber) | .date = $date)' \
              apps.json > apps.json.tmp; then
                mv apps.json.tmp apps.json
                echo "Successfully updated $NAME to version $VERSION"
            else
                echo "Error: Failed to process JSON for $NAME."
                rm -f apps.json.tmp
            fi
          done

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: sync latest app releases"
          file_pattern: 'apps.json'
